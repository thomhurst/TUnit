# TUnit Reflection-Free Implementation

## Overview

TUnit now supports fully reflection-free test execution through advanced source generation, enabling AOT (Ahead-of-Time) compilation and improved performance. This document describes the implementation details and usage patterns.

## Key Features

### 1. Compile-Time Test Discovery
All tests are discovered at compile time through source generators, eliminating the need for runtime reflection scanning.

### 2. Strongly-Typed Delegates
Test invocation uses pre-compiled, strongly-typed delegates stored in a centralized registry:
- `TestDelegateStorage` - Central storage for all delegates
- Instance factories for test class instantiation
- Test method invokers with proper async support
- Data source factories for parameterized tests

### 3. AOT-Friendly Data Sources
Data sources are resolved at compile time and stored as factories:
- Static data (from `[Arguments]`) compiled directly
- Dynamic data sources pre-registered with factory keys
- Full support for async data sources without reflection

## Architecture

### Source Generation Pipeline

1. **UnifiedTestMetadataGenerator**
   - Scans for test methods during compilation
   - Generates `TestMetadata` instances with delegate references
   - Creates module initializers for automatic registration

2. **Delegate Registration**
   - Instance factories: `TestDelegateStorage.RegisterInstanceFactory(key, factory)`
   - Test invokers: `TestDelegateStorage.RegisterTestInvoker(key, invoker)`
   - Data source factories: `TestDelegateStorage.RegisterDataSourceFactory(key, factory)`

3. **Runtime Execution**
   - Tests retrieved from pre-registered metadata
   - Delegates invoked directly without reflection
   - Full async/await support maintained

## Generated Code Example

```csharp
// Generated by UnifiedTestMetadataGenerator
public static class UnifiedTestMetadataRegistry
{
    [ModuleInitializer]
    public static void Initialize()
    {
        RegisterAllDelegates();
        RegisterAllTests();
    }

    private static void RegisterAllDelegates()
    {
        // Register instance factory
        TestDelegateStorage.RegisterInstanceFactory(
            "MyNamespace.MyTestClass",
            args => new MyTestClass());

        // Register test invoker
        TestDelegateStorage.RegisterTestInvoker(
            "MyNamespace.MyTestClass.MyTestMethod",
            MyNamespace_MyTestClass_MyTestMethod_Invoker);
    }

    private static async Task MyNamespace_MyTestClass_MyTestMethod_Invoker(
        object instance, object?[] args)
    {
        var typedInstance = (MyNamespace.MyTestClass)instance;
        await typedInstance.MyTestMethod();
    }
}
```

## Usage

### Basic Test
```csharp
using TUnit.Core;

public class BasicTests
{
    [Test]
    public async Task SimpleTest()
    {
        await Task.Delay(10);
        // Test implementation
    }
}
```

### Parameterized Test
```csharp
[Test]
[Arguments(1, 2, 3)]
[Arguments(4, 5, 9)]
public void TestWithArguments(int a, int b, int expectedSum)
{
    var sum = a + b;
    Assert.That(sum).IsEqualTo(expectedSum);
}
```

### Dynamic Data Source
```csharp
[Test]
[MethodDataSource(typeof(DataProvider), nameof(DataProvider.GetTestData))]
public void DataDrivenTest(string input, int expected)
{
    // Test implementation
}

public static class DataProvider
{
    public static IEnumerable<object[]> GetTestData()
    {
        yield return new object[] { "test", 4 };
        yield return new object[] { "hello", 5 };
    }
}
```

## Configuration

### Project Setup
To enable reflection-free source generation, ensure your test project references the source generator:

```xml
<ItemGroup>
  <ProjectReference Include="path/to/TUnit.csproj" />
  <ProjectReference Include="path/to/TUnit.Core.SourceGenerator.csproj" 
                    OutputItemType="Analyzer" 
                    ReferenceOutputAssembly="false" />
</ItemGroup>
```

### AOT Publishing
```bash
dotnet publish -c Release -r linux-x64 --self-contained -p:PublishAot=true
```

## Benefits

1. **Performance**: No reflection overhead at runtime
2. **AOT Compatibility**: Full support for Native AOT compilation
3. **Trimming**: Unused code can be safely trimmed
4. **Type Safety**: Compile-time verification of test signatures
5. **Startup Time**: Faster test discovery and execution startup

## Limitations

1. Generic test classes with unresolved type parameters require explicit instantiation
2. Abstract test classes are not directly supported (use `[InheritsTests]` on derived classes)
3. Dynamic test generation at runtime is not supported in AOT mode

## Migration Guide

Existing TUnit tests require no code changes. The source generator automatically detects and handles:
- Test methods with `[Test]` attribute
- Data sources (`[Arguments]`, `[MethodDataSource]`, etc.)
- Test hooks (`[Before]`, `[After]`, etc.)
- Class-level data sources
- Property injection

## Troubleshooting

### Tests Not Discovered
- Ensure the source generator project reference is configured correctly
- Check that test methods are public and properly attributed
- Verify the test class is not abstract or generic with unresolved parameters

### Build Errors
- Clean and rebuild the solution to regenerate source files
- Check for conflicting analyzer versions
- Ensure all TUnit packages are the same version

### Runtime Errors
- Verify delegate registration completed (check console output)
- Ensure test assembly is not trimmed if using PublishTrimmed
- Check that all data source methods are accessible

## Performance Considerations

The reflection-free implementation provides:
- Zero reflection calls during test execution
- Pre-compiled delegates for optimal invocation performance
- Reduced memory allocation through delegate caching
- Faster startup times due to compile-time discovery

For maximum performance:
1. Use static data sources when possible
2. Avoid complex object initialization in test constructors
3. Leverage parallel execution capabilities
4. Consider using `[NotInParallel]` only when necessary