using System.Diagnostics.CodeAnalysis;
using System.Text;

namespace TUnit.Core.SourceGenerator;

public class SourceCodeWriter : IDisposable
{
    public int TabLevel
    {
        get;
        private set;
    }

    private readonly StringBuilder _stringBuilder = new();

    public SourceCodeWriter(int tabLevel = 0, char lastCharacter = ' ')
    {
        TabLevel = tabLevel;

        if (tabLevel is 0)
        {
            _stringBuilder.AppendLine("// <auto-generated/>");
        }
    }

    private static char[] _startOfStringTabLevelIncreasingChars = ['{', '['];
    private static char[] _tabLevelDecreasingChars = ['}', ']'];

    private static char[] _endOfStringNewLineTriggerringChars = [',', ';', ']'];
    private static string[] _startOfStringNewLineTriggerringStrings = ["#pragma", "}"];

    public void WriteLine()
    {
        _stringBuilder.AppendLine();
    }

    public void Write([StringSyntax("c#")] string value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return;
        }

        var tempTabCount = 0;
        if (value.Length > 0 && value[0] == '\t')
        {
            tempTabCount = value.TakeWhile(c => c == '\t').Count();
        }

        TabLevel -= tempTabCount;

        if (_tabLevelDecreasingChars.Contains(value[0]))
        {
            TabLevel--;
        }

        if (_startOfStringTabLevelIncreasingChars.Contains(value[0]))
        {
            _stringBuilder.AppendLine();
        }

        for (var i = 0; i < TabLevel; i++)
        {
            _stringBuilder.Append('\t');
        }

        _stringBuilder.Append(value);

        if (ShouldAppendNewLineAfterWritingValue(value))
        {
            _stringBuilder.AppendLine();
        }

        if (_startOfStringTabLevelIncreasingChars.Contains(value[0])
            && !_tabLevelDecreasingChars.Contains(value[^1]))
        {
            TabLevel++;
        }

        TabLevel += tempTabCount;
    }

    private static bool ShouldAppendNewLineAfterWritingValue(string value)
    {
        if (_endOfStringNewLineTriggerringChars.Contains(value[^1]))
        {
            return true;
        }

        if (_startOfStringTabLevelIncreasingChars.Contains(value[0]))
        {
            return true;
        }

        return _startOfStringNewLineTriggerringStrings.Any(x => value.StartsWith(x, StringComparison.Ordinal));
    }

    public override string ToString()
    {
        return _stringBuilder.ToString();
    }

    public void Dispose()
    {
        _stringBuilder.Clear();
    }
}
