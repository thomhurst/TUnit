"use strict";(self.webpackChunktunit_docs_site=self.webpackChunktunit_docs_site||[]).push([[6479],{12670:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"examples/aspnet","title":"ASP.NET Core Integration Testing","description":"TUnit provides first-class support for ASP.NET Core integration testing through the TUnit.AspNetCore package. This package enables per-test isolation with shared infrastructure, making it easy to write fast, parallel integration tests.","source":"@site/docs/examples/aspnet.md","sourceDirName":"examples","slug":"/examples/aspnet","permalink":"/docs/examples/aspnet","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"TUnit in CI/CD Pipelines","permalink":"/docs/examples/tunit-ci-pipeline"},"next":{"title":"Playwright","permalink":"/docs/examples/playwright"}}');var r=s(74848),i=s(28453);const a={},o="ASP.NET Core Integration Testing",c={},l=[{value:"Installation",id:"installation",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"1. Create a Test Factory",id:"1-create-a-test-factory",level:3},{value:"2. Create a Test Base Class",id:"2-create-a-test-base-class",level:3},{value:"3. Write Tests",id:"3-write-tests",level:3},{value:"Core Concepts",id:"core-concepts",level:2},{value:"Why Test Isolation Matters",id:"why-test-isolation-matters",level:3},{value:"WebApplicationTest Pattern",id:"webapplicationtest-pattern",level:3},{value:"Lifecycle Order",id:"lifecycle-order",level:3},{value:"Override Methods",id:"override-methods",level:2},{value:"ConfigureTestOptions",id:"configuretestoptions",level:3},{value:"SetupAsync",id:"setupasync",level:3},{value:"ConfigureTestServices",id:"configuretestservices",level:3},{value:"ConfigureTestConfiguration",id:"configuretestconfiguration",level:3},{value:"ConfigureWebHostBuilder",id:"configurewebhostbuilder",level:3},{value:"Test Isolation Helpers",id:"test-isolation-helpers",level:2},{value:"GetIsolatedName",id:"getisolatedname",level:3},{value:"GetIsolatedPrefix",id:"getisolatedprefix",level:3},{value:"Container Integration",id:"container-integration",level:2},{value:"With Testcontainers",id:"with-testcontainers",level:3},{value:"Per-Test Table Isolation",id:"per-test-table-isolation",level:3},{value:"HTTP Exchange Capture",id:"http-exchange-capture",level:2},{value:"Capture Options",id:"capture-options",level:3},{value:"Inspecting Captured Exchanges",id:"inspecting-captured-exchanges",level:3},{value:"TUnit Logging Integration",id:"tunit-logging-integration",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Isolate Shared Resources",id:"1-always-isolate-shared-resources",level:3},{value:"2. Use Base Classes for Common Setup",id:"2-use-base-classes-for-common-setup",level:3},{value:"3. Clean Up Resources",id:"3-clean-up-resources",level:3},{value:"4. Inject Containers at Factory Level",id:"4-inject-containers-at-factory-level",level:3},{value:"Complete Example",id:"complete-example",level:2},{value:"Migrating from Basic WebApplicationFactory",id:"migrating-from-basic-webapplicationfactory",level:2},{value:"FAQ &amp; Troubleshooting",id:"faq--troubleshooting",level:2},{value:"Why does my test configuration not override the factory?",id:"why-does-my-test-configuration-not-override-the-factory",level:3},{value:"Why can&#39;t I access SetupAsync results in ConfigureTestOptions?",id:"why-cant-i-access-setupasync-results-in-configuretestoptions",level:3},{value:"Why are my parallel tests interfering with each other?",id:"why-are-my-parallel-tests-interfering-with-each-other",level:3},{value:"Can I have different factory configurations for different test classes?",id:"can-i-have-different-factory-configurations-for-different-test-classes",level:3},{value:"What&#39;s the difference between Factory and GlobalFactory?",id:"whats-the-difference-between-factory-and-globalfactory",level:3},{value:"Why does my service registration not work?",id:"why-does-my-service-registration-not-work",level:3},{value:"How do I debug lifecycle issues?",id:"how-do-i-debug-lifecycle-issues",level:3},{value:"Can I run async code in ConfigureTestServices?",id:"can-i-run-async-code-in-configuretestservices",level:3},{value:"Why does my Program.cs run before ConfigureWebHost&#39;s ConfigureAppConfiguration?",id:"why-does-my-programcs-run-before-configurewebhosts-configureappconfiguration",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"WebApplicationTest Properties",id:"webapplicationtest-properties",level:3},{value:"WebApplicationTest Methods",id:"webapplicationtest-methods",level:3},{value:"WebApplicationTestOptions",id:"webapplicationtestoptions",level:3},{value:"Service Collection Extensions",id:"service-collection-extensions",level:3}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"aspnet-core-integration-testing",children:"ASP.NET Core Integration Testing"})}),"\n",(0,r.jsxs)(n.p,{children:["TUnit provides first-class support for ASP.NET Core integration testing through the ",(0,r.jsx)(n.code,{children:"TUnit.AspNetCore"})," package. This package enables per-test isolation with shared infrastructure, making it easy to write fast, parallel integration tests."]}),"\n",(0,r.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet add package TUnit.AspNetCore\n"})}),"\n",(0,r.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsx)(n.h3,{id:"1-create-a-test-factory",children:"1. Create a Test Factory"}),"\n",(0,r.jsxs)(n.p,{children:["Create a factory that extends ",(0,r.jsx)(n.code,{children:"TestWebApplicationFactory<TEntryPoint>"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using TUnit.AspNetCore;\nusing TUnit.Core.Interfaces;\n\npublic class WebApplicationFactory : TestWebApplicationFactory<Program>\n{\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        // Configure shared services and settings\n        builder.ConfigureAppConfiguration((context, config) =>\n        {\n            config.AddInMemoryCollection(new Dictionary<string, string?>\n            {\n                { "ConnectionStrings:Default", "..." }\n            });\n        });\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-create-a-test-base-class",children:"2. Create a Test Base Class"}),"\n",(0,r.jsxs)(n.p,{children:["Create a base class that extends ",(0,r.jsx)(n.code,{children:"WebApplicationTest<TFactory, TEntryPoint>"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"using TUnit.AspNetCore;\n\npublic abstract class TestsBase : WebApplicationTest<WebApplicationFactory, Program>\n{\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-write-tests",children:"3. Write Tests"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class TodoApiTests : TestsBase\n{\n    [Test]\n    public async Task GetTodos_ReturnsOk()\n    {\n        var client = Factory.CreateClient();\n\n        var response = await client.GetAsync("/todos");\n\n        await Assert.That(response.StatusCode).IsEqualTo(HttpStatusCode.OK);\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,r.jsx)(n.h3,{id:"why-test-isolation-matters",children:"Why Test Isolation Matters"}),"\n",(0,r.jsx)(n.admonition,{title:"Critical for Parallel Execution",type:"warning",children:(0,r.jsx)(n.p,{children:"TUnit runs tests in parallel by default. Without proper isolation, tests will interfere with each other, causing flaky failures that are difficult to debug."})}),"\n",(0,r.jsx)(n.p,{children:"When tests share resources like database tables, message queues, or cache keys, you'll encounter problems:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Shared Resource"}),(0,r.jsx)(n.th,{children:"What Goes Wrong"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Database table"}),(0,r.jsxs)(n.td,{children:["Test A inserts a record, Test B's ",(0,r.jsx)(n.code,{children:"COUNT(*)"})," assertion fails"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Message queue"}),(0,r.jsx)(n.td,{children:"Test A consumes Test B's messages"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Cache key"}),(0,r.jsx)(n.td,{children:"Test A overwrites Test B's cached data"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Redis key"}),(0,r.jsx)(n.td,{children:"Test A deletes keys that Test B is using"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"S3 bucket path"}),(0,r.jsx)(n.td,{children:"Test A's cleanup deletes Test B's files"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"The solution"}),": Give each test its own isolated resources using ",(0,r.jsx)(n.code,{children:"GetIsolatedName()"})," and ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'protected override async Task SetupAsync()\n{\n    // Each test gets unique resources that no other test will touch\n    var tableName = GetIsolatedName("todos");      // "Test_42_todos"\n    var queueName = GetIsolatedName("events");     // "Test_42_events"\n    var cachePrefix = GetIsolatedPrefix();         // "test_42_"\n\n    await CreateTableAsync(tableName);\n    await CreateQueueAsync(queueName);\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"This ensures:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tests can run in parallel without interference"}),"\n",(0,r.jsx)(n.li,{children:"Test failures are deterministic and reproducible"}),"\n",(0,r.jsxs)(n.li,{children:["You can run the same test multiple times (with ",(0,r.jsx)(n.code,{children:"[Repeat]"}),") safely"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"webapplicationtest-pattern",children:"WebApplicationTest Pattern"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"WebApplicationTest<TFactory, TEntryPoint>"})," base class provides:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Per-test isolation"}),": Each test gets its own delegating factory via ",(0,r.jsx)(n.code,{children:"WithWebHostBuilder"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Shared infrastructure"}),": The global factory (containers, connections) is shared across tests"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Parallel execution"}),": Tests run in parallel with complete isolation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Lifecycle hooks"}),": Async setup runs before sync configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"lifecycle-order",children:"Lifecycle Order"}),"\n",(0,r.jsx)(n.p,{children:"Understanding the execution order is critical for writing correct tests. Here's the complete verified order:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    TEST LIFECYCLE                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  1. ConfigureTestOptions        Set test options (HTTP capture) \u2502\n\u2502  2. SetupAsync                  Async setup (create tables)     \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500    \u2502\n\u2502  3. Factory.ConfigureWebHost    Base factory configuration      \u2502\n\u2502  4. Factory.ConfigureStartup... Base factory startup config     \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500    \u2502\n\u2502  5. ConfigureTestConfiguration  Test config (overrides factory) \u2502\n\u2502  6. ConfigureWebHostBuilder     Escape hatch (low-level access) \u2502\n\u2502  7. ConfigureTestServices       Test services (overrides)       \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500    \u2502\n\u2502  8. Application Startup         Server starts                   \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500    \u2502\n\u2502  9. Test Method Executes        Your test code runs             \u2502\n\u2502 10. Factory Disposed            Cleanup                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Hook"}),(0,r.jsx)(n.th,{children:"Scope"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigureTestOptions"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Enable features like HTTP capture"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SetupAsync"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Async operations before config (create DB tables)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Factory.ConfigureWebHost"})}),(0,r.jsx)(n.td,{children:"Shared"}),(0,r.jsx)(n.td,{children:"Base configuration for all tests"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Factory.ConfigureStartupConfiguration"})}),(0,r.jsx)(n.td,{children:"Shared"}),(0,r.jsx)(n.td,{children:"Base startup configuration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigureTestConfiguration"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Override factory configuration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigureWebHostBuilder"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Low-level escape hatch"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigureTestServices"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Override factory services"})]})]})]}),"\n",(0,r.jsx)(n.admonition,{title:"Tests Can Override Factory",type:"tip",children:(0,r.jsxs)(n.p,{children:["The order is designed so that ",(0,r.jsx)(n.strong,{children:"tests can override factory defaults"}),". Factory configuration runs first (steps 3-4), then test-specific configuration (steps 5-7) can override those values."]})}),"\n",(0,r.jsx)(n.admonition,{title:"Factory Methods Run Once",type:"warning",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Factory.ConfigureWebHost"})," and ",(0,r.jsx)(n.code,{children:"Factory.ConfigureStartupConfiguration"})," run ",(0,r.jsx)(n.strong,{children:"once per test session"})," (when the factory is first used), not per-test. If different test classes need fundamentally different factory configurations, use different factory classes."]})}),"\n",(0,r.jsx)(n.h2,{id:"override-methods",children:"Override Methods"}),"\n",(0,r.jsx)(n.h3,{id:"configuretestoptions",children:"ConfigureTestOptions"}),"\n",(0,r.jsx)(n.p,{children:"Use to configure test-level options before anything else runs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"protected override void ConfigureTestOptions(WebApplicationTestOptions options)\n{\n    options.EnableHttpExchangeCapture = true;  // Capture HTTP requests/responses\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This runs ",(0,r.jsx)(n.strong,{children:"first"})," in the lifecycle, before ",(0,r.jsx)(n.code,{children:"SetupAsync"}),". Use it to enable features that affect how the test infrastructure is set up."]}),"\n",(0,r.jsx)(n.h3,{id:"setupasync",children:"SetupAsync"}),"\n",(0,r.jsx)(n.p,{children:"Use for async operations that must complete before the factory is created:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class TodoTests : TestsBase\n{\n    protected string TableName { get; private set; } = null!;\n\n    protected override async Task SetupAsync()\n    {\n        TableName = GetIsolatedName("todos");\n        await CreateTableAsync(TableName);\n    }\n\n    protected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n    {\n        // TableName is already set from SetupAsync\n        config.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "Database:TableName", TableName }\n        });\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"configuretestservices",children:"ConfigureTestServices"}),"\n",(0,r.jsx)(n.p,{children:"Use for DI configuration:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"protected override void ConfigureTestServices(IServiceCollection services)\n{\n    // Replace a service with a mock\n    services.ReplaceService<IEmailService>(new FakeEmailService());\n\n    // Add test-specific services\n    services.AddSingleton<ITestHelper, TestHelper>();\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuretestconfiguration",children:"ConfigureTestConfiguration"}),"\n",(0,r.jsx)(n.p,{children:"Use for app configuration:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'protected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n{\n    config.AddInMemoryCollection(new Dictionary<string, string?>\n    {\n        { "Feature:Enabled", "true" },\n        { "Api:BaseUrl", "https://test.example.com" }\n    });\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"configurewebhostbuilder",children:"ConfigureWebHostBuilder"}),"\n",(0,r.jsx)(n.p,{children:"Escape hatch for advanced scenarios:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'protected override void ConfigureWebHostBuilder(IWebHostBuilder builder)\n{\n    builder.UseEnvironment("Staging");\n    builder.UseSetting("MyFeature:Enabled", "true");\n    builder.ConfigureKestrel(options => options.AddServerHeader = false);\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"test-isolation-helpers",children:"Test Isolation Helpers"}),"\n",(0,r.jsx)(n.h3,{id:"getisolatedname",children:"GetIsolatedName"}),"\n",(0,r.jsx)(n.p,{children:"Creates a unique name for resources like database tables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// In a test with UniqueId = 42:\nvar tableName = GetIsolatedName("todos");  // Returns "Test_42_todos"\nvar topicName = GetIsolatedName("orders"); // Returns "Test_42_orders"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"getisolatedprefix",children:"GetIsolatedPrefix"}),"\n",(0,r.jsx)(n.p,{children:"Creates a unique prefix for key-based resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// In a test with UniqueId = 42:\nvar prefix = GetIsolatedPrefix();       // Returns "test_42_"\nvar dotPrefix = GetIsolatedPrefix("."); // Returns "test.42."\n'})}),"\n",(0,r.jsx)(n.h2,{id:"container-integration",children:"Container Integration"}),"\n",(0,r.jsx)(n.h3,{id:"with-testcontainers",children:"With Testcontainers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class InMemoryDatabase : IAsyncInitializer, IAsyncDisposable\n{\n    public PostgreSqlContainer Container { get; } = new PostgreSqlBuilder()\n        .WithImage("postgres:16-alpine")\n        .Build();\n\n    public async Task InitializeAsync() => await Container.StartAsync();\n    public async ValueTask DisposeAsync() => await Container.DisposeAsync();\n}\n\npublic class WebApplicationFactory : TestWebApplicationFactory<Program>\n{\n    [ClassDataSource<InMemoryDatabase>(Shared = SharedType.PerTestSession)]\n    public InMemoryDatabase Database { get; init; } = null!;\n\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        builder.ConfigureAppConfiguration((_, config) =>\n        {\n            config.AddInMemoryCollection(new Dictionary<string, string?>\n            {\n                { "Database:ConnectionString", Database.Container.GetConnectionString() }\n            });\n        });\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"per-test-table-isolation",children:"Per-Test Table Isolation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public abstract class TodoTestBase : TestsBase\n{\n    [ClassDataSource<InMemoryDatabase>(Shared = SharedType.PerTestSession)]\n    public InMemoryDatabase Database { get; init; } = null!;\n\n    protected string TableName { get; private set; } = null!;\n\n    protected override async Task SetupAsync()\n    {\n        TableName = GetIsolatedName("todos");\n        await CreateTableAsync(TableName);\n    }\n\n    protected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n    {\n        config.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "Database:TableName", TableName }\n        });\n    }\n\n    [After(HookType.Test)]\n    public async Task CleanupTable()\n    {\n        await DropTableAsync(TableName);\n    }\n\n    private async Task CreateTableAsync(string name) { /* ... */ }\n    private async Task DropTableAsync(string name) { /* ... */ }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"http-exchange-capture",children:"HTTP Exchange Capture"}),"\n",(0,r.jsx)(n.p,{children:"Capture and inspect HTTP requests/responses for assertions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class CaptureTests : TestsBase\n{\n    protected override WebApplicationTestOptions Options => new()\n    {\n        EnableHttpExchangeCapture = true\n    };\n\n    [Test]\n    public async Task RequestIsCaptured()\n    {\n        var client = Factory.CreateClient();\n\n        await client.GetAsync("/api/todos");\n\n        await Assert.That(HttpCapture).IsNotNull();\n        await Assert.That(HttpCapture!.Last!.Response.StatusCode)\n            .IsEqualTo(HttpStatusCode.OK);\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"capture-options",children:"Capture Options"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"protected override WebApplicationTestOptions Options => new()\n{\n    EnableHttpExchangeCapture = true,\n    CaptureRequestBody = true,\n    CaptureResponseBody = true,\n    MaxBodySize = 1024 * 1024  // 1MB limit\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"inspecting-captured-exchanges",children:"Inspecting Captured Exchanges"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Get the last exchange\nvar last = HttpCapture!.Last;\n\n// Get all exchanges\nvar all = HttpCapture.All;\n\n// Inspect request\nawait Assert.That(last!.Request.Method).IsEqualTo("POST");\nawait Assert.That(last.Request.Path).IsEqualTo("/api/todos");\nawait Assert.That(last.Request.Body).Contains("\\"title\\"");\n\n// Inspect response\nawait Assert.That(last.Response.StatusCode).IsEqualTo(HttpStatusCode.Created);\nawait Assert.That(last.Response.Body).Contains("\\"id\\"");\n'})}),"\n",(0,r.jsx)(n.h2,{id:"tunit-logging-integration",children:"TUnit Logging Integration"}),"\n",(0,r.jsx)(n.p,{children:"Server logs are automatically correlated with TUnit test output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"protected override WebApplicationTestOptions Options => new()\n{\n    AddTUnitLogging = true  // Default is true\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:"Logs from your ASP.NET Core app will appear in the test output, making debugging easier."}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"1-always-isolate-shared-resources",children:"1. Always Isolate Shared Resources"}),"\n",(0,r.jsx)(n.admonition,{title:"Golden Rule",type:"tip",children:(0,r.jsx)(n.p,{children:"If a resource is shared (database, queue, cache), each test must use its own isolated instance of that resource."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// \u274c BAD: All tests share the same table - will cause flaky failures\nprotected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n{\n    config.AddInMemoryCollection(new Dictionary<string, string?>\n    {\n        { "Database:TableName", "todos" }  // Shared = flaky!\n    });\n}\n\n// \u2705 GOOD: Each test gets its own table\nprotected override async Task SetupAsync()\n{\n    TableName = GetIsolatedName("todos");  // "Test_42_todos"\n    await CreateTableAsync(TableName);\n}\n\nprotected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n{\n    config.AddInMemoryCollection(new Dictionary<string, string?>\n    {\n        { "Database:TableName", TableName }  // Isolated = reliable!\n    });\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Common resources that need isolation:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database tables"}),": Use ",(0,r.jsx)(n.code,{children:'GetIsolatedName("tablename")'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Message queues/topics"}),": Use ",(0,r.jsx)(n.code,{children:'GetIsolatedName("queue")'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache keys"}),": Use ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix()"})," as a key prefix"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Blob storage paths"}),": Use ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix()"})," as a path prefix"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Redis keys"}),": Use ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix()"})," as a key prefix"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-use-base-classes-for-common-setup",children:"2. Use Base Classes for Common Setup"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"// Shared base for all tests\npublic abstract class TestsBase : WebApplicationTest<WebApplicationFactory, Program>\n{\n}\n\n// Specialized base for database tests\npublic abstract class DatabaseTestBase : TestsBase\n{\n    protected override async Task SetupAsync()\n    {\n        await CreateSchemaAsync();\n    }\n}\n\n// Actual tests\npublic class UserTests : DatabaseTestBase\n{\n    [Test]\n    public async Task CreateUser_Works() { /* ... */ }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-clean-up-resources",children:"3. Clean Up Resources"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"[After(HookType.Test)]\npublic async Task Cleanup()\n{\n    await CleanupTestDataAsync();\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-inject-containers-at-factory-level",children:"4. Inject Containers at Factory Level"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class WebApplicationFactory : TestWebApplicationFactory<Program>\n{\n    // Shared across all tests\n    [ClassDataSource<PostgresContainer>(Shared = SharedType.PerTestSession)]\n    public PostgresContainer Postgres { get; init; } = null!;\n\n    [ClassDataSource<RedisContainer>(Shared = SharedType.PerTestSession)]\n    public RedisContainer Redis { get; init; } = null!;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Container wrapper\npublic class InMemoryPostgres : IAsyncInitializer, IAsyncDisposable\n{\n    public PostgreSqlContainer Container { get; } = new PostgreSqlBuilder().Build();\n    public async Task InitializeAsync() => await Container.StartAsync();\n    public async ValueTask DisposeAsync() => await Container.DisposeAsync();\n}\n\n// Factory with shared container\npublic class WebApplicationFactory : TestWebApplicationFactory<Program>\n{\n    [ClassDataSource<InMemoryPostgres>(Shared = SharedType.PerTestSession)]\n    public InMemoryPostgres Postgres { get; init; } = null!;\n\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        builder.ConfigureAppConfiguration((_, config) =>\n        {\n            config.AddInMemoryCollection(new Dictionary<string, string?>\n            {\n                { "Database:ConnectionString", Postgres.Container.GetConnectionString() }\n            });\n        });\n    }\n}\n\n// Base class\npublic abstract class TestsBase : WebApplicationTest<WebApplicationFactory, Program>\n{\n}\n\n// Test base with table isolation\npublic abstract class TodoTestBase : TestsBase\n{\n    [ClassDataSource<InMemoryPostgres>(Shared = SharedType.PerTestSession)]\n    public InMemoryPostgres Postgres { get; init; } = null!;\n\n    protected string TableName { get; private set; } = null!;\n\n    protected override async Task SetupAsync()\n    {\n        TableName = GetIsolatedName("todos");\n        await CreateTableAsync();\n    }\n\n    protected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n    {\n        config.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "Database:TableName", TableName }\n        });\n    }\n\n    [After(HookType.Test)]\n    public async Task Cleanup() => await DropTableAsync();\n\n    private async Task CreateTableAsync() { /* ... */ }\n    private async Task DropTableAsync() { /* ... */ }\n}\n\n// Actual tests\npublic class TodoApiTests : TodoTestBase\n{\n    [Test]\n    public async Task CreateTodo_ReturnsCreated()\n    {\n        var client = Factory.CreateClient();\n\n        var response = await client.PostAsJsonAsync("/todos", new { Title = "Test" });\n\n        await Assert.That(response.StatusCode).IsEqualTo(HttpStatusCode.Created);\n    }\n\n    [Test, Repeat(5)]\n    public async Task ParallelTests_AreIsolated()\n    {\n        var client = Factory.CreateClient();\n\n        // Each repetition has its own table\n        await client.PostAsJsonAsync("/todos", new { Title = "Isolated" });\n\n        var todos = await client.GetFromJsonAsync<List<Todo>>("/todos");\n        await Assert.That(todos!.Count).IsEqualTo(1);  // Always 1, not 5\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"migrating-from-basic-webapplicationfactory",children:"Migrating from Basic WebApplicationFactory"}),"\n",(0,r.jsxs)(n.p,{children:["If you're currently using ",(0,r.jsx)(n.code,{children:"WebApplicationFactory<TEntryPoint>"})," directly:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Before:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class MyTests\n{\n    [ClassDataSource<WebAppFactory>(Shared = SharedType.PerTestSession)]\n    public required WebAppFactory Factory { get; init; }\n\n    [Test]\n    public async Task Test1()\n    {\n        var client = Factory.CreateClient();\n        // Tests share state - not isolated!\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"After:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class MyTests : WebApplicationTest<WebAppFactory, Program>\n{\n    [Test]\n    public async Task Test1()\n    {\n        var client = Factory.CreateClient();  // Isolated per test!\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"The key benefits:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Each test gets its own isolated factory via ",(0,r.jsx)(n.code,{children:"WithWebHostBuilder"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SetupAsync"})," enables async initialization before factory creation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ConfigureTestServices"})," and ",(0,r.jsx)(n.code,{children:"ConfigureTestConfiguration"})," are per-test"]}),"\n",(0,r.jsxs)(n.li,{children:["Built-in isolation helpers (",(0,r.jsx)(n.code,{children:"GetIsolatedName"}),", ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"faq--troubleshooting",children:"FAQ & Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"why-does-my-test-configuration-not-override-the-factory",children:"Why does my test configuration not override the factory?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," You set a value in ",(0,r.jsx)(n.code,{children:"ConfigureTestConfiguration"})," but the factory's value is still used."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Make sure you're using the same configuration key. The test configuration runs ",(0,r.jsx)(n.strong,{children:"after"})," the factory configuration (step 5 vs steps 3-4), so it should override. Check that:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["You're using ",(0,r.jsx)(n.code,{children:"AddInMemoryCollection"})," which adds to the config sources"]}),"\n",(0,r.jsx)(n.li,{children:"The configuration key path is exactly the same"}),"\n",(0,r.jsxs)(n.li,{children:["You're not accidentally reading from a different source (e.g., ",(0,r.jsx)(n.code,{children:"appsettings.json"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Factory sets default\nprotected override void ConfigureWebHost(IWebHostBuilder builder)\n{\n    builder.ConfigureAppConfiguration((_, config) =>\n    {\n        config.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "Database:ConnectionString", "factory-default" }\n        });\n    });\n}\n\n// Test overrides - this WILL work because it runs after\nprotected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n{\n    config.AddInMemoryCollection(new Dictionary<string, string?>\n    {\n        { "Database:ConnectionString", "test-specific-value" }  // This wins!\n    });\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"why-cant-i-access-setupasync-results-in-configuretestoptions",children:"Why can't I access SetupAsync results in ConfigureTestOptions?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," You want to use a value from ",(0,r.jsx)(n.code,{children:"SetupAsync"})," in ",(0,r.jsx)(n.code,{children:"ConfigureTestOptions"}),", but ",(0,r.jsx)(n.code,{children:"ConfigureTestOptions"})," runs first."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," This is by design. ",(0,r.jsx)(n.code,{children:"ConfigureTestOptions"})," runs before ",(0,r.jsx)(n.code,{children:"SetupAsync"})," because test options affect how the infrastructure is set up. If you need async setup before options, consider:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Moving the logic to a ",(0,r.jsx)(n.code,{children:"[Before(HookType.Test)]"})," method that runs even earlier"]}),"\n",(0,r.jsxs)(n.li,{children:["Using lazy initialization in ",(0,r.jsx)(n.code,{children:"SetupAsync"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"why-are-my-parallel-tests-interfering-with-each-other",children:"Why are my parallel tests interfering with each other?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Tests that pass individually fail when run in parallel."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," You're sharing resources without isolation. Use ",(0,r.jsx)(n.code,{children:"GetIsolatedName()"})," and ",(0,r.jsx)(n.code,{children:"GetIsolatedPrefix()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// BAD: All parallel tests share the same table\nvar tableName = "todos";\n\n// GOOD: Each test gets its own table\nvar tableName = GetIsolatedName("todos");  // "Test_42_todos", "Test_43_todos", etc.\n'})}),"\n",(0,r.jsx)(n.h3,{id:"can-i-have-different-factory-configurations-for-different-test-classes",children:"Can I have different factory configurations for different test classes?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Test class A needs PostgreSQL, test class B needs SQLite."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Create different factory classes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class PostgresFactory : TestWebApplicationFactory<Program>\n{\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        // PostgreSQL configuration\n    }\n}\n\npublic class SqliteFactory : TestWebApplicationFactory<Program>\n{\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        // SQLite configuration\n    }\n}\n\npublic class PostgresTests : WebApplicationTest<PostgresFactory, Program> { }\npublic class SqliteTests : WebApplicationTest<SqliteFactory, Program> { }\n"})}),"\n",(0,r.jsx)(n.h3,{id:"whats-the-difference-between-factory-and-globalfactory",children:"What's the difference between Factory and GlobalFactory?"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Property"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Scope"}),(0,r.jsx)(n.th,{children:"Use Case"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Factory"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"WebApplicationFactory<TEntryPoint>"})}),(0,r.jsx)(n.td,{children:"Per-test"}),(0,r.jsx)(n.td,{children:"Creating HTTP clients, accessing services"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GlobalFactory"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"TFactory"})," (your custom type)"]}),(0,r.jsx)(n.td,{children:"Shared"}),(0,r.jsx)(n.td,{children:"Accessing custom factory properties (containers, etc.)"})]})]})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class MyTests : WebApplicationTest<WebApplicationFactory, Program>\n{\n    [Test]\n    public async Task Example()\n    {\n        // Use Factory for per-test operations\n        var client = Factory.CreateClient();\n        var services = Factory.Services;\n\n        // Use GlobalFactory to access custom properties\n        var connectionString = GlobalFactory.Database.Container.GetConnectionString();\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"why-does-my-service-registration-not-work",children:"Why does my service registration not work?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," You register a service in ",(0,r.jsx)(n.code,{children:"ConfigureTestServices"})," but the old implementation is still used."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Use ",(0,r.jsx)(n.code,{children:"ReplaceService"})," instead of ",(0,r.jsx)(n.code,{children:"AddSingleton"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"protected override void ConfigureTestServices(IServiceCollection services)\n{\n    // BAD: Adds a second registration, original may still be resolved\n    services.AddSingleton<IEmailService, FakeEmailService>();\n\n    // GOOD: Removes existing registration and adds new one\n    services.ReplaceService<IEmailService>(new FakeEmailService());\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"how-do-i-debug-lifecycle-issues",children:"How do I debug lifecycle issues?"}),"\n",(0,r.jsx)(n.p,{children:"Create a test that logs all lifecycle events:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class LifecycleDebugTest : WebApplicationTest<WebApplicationFactory, Program>\n{\n    protected override void ConfigureTestOptions(WebApplicationTestOptions options)\n    {\n        Console.WriteLine("1. ConfigureTestOptions");\n    }\n\n    protected override async Task SetupAsync()\n    {\n        Console.WriteLine("2. SetupAsync");\n        await base.SetupAsync();\n    }\n\n    protected override void ConfigureTestConfiguration(IConfigurationBuilder config)\n    {\n        Console.WriteLine("5. ConfigureTestConfiguration");\n    }\n\n    protected override void ConfigureWebHostBuilder(IWebHostBuilder builder)\n    {\n        Console.WriteLine("6. ConfigureWebHostBuilder");\n    }\n\n    protected override void ConfigureTestServices(IServiceCollection services)\n    {\n        Console.WriteLine("7. ConfigureTestServices");\n    }\n\n    [Test]\n    public async Task Debug_Lifecycle()\n    {\n        Console.WriteLine("9. Test executing");\n        _ = Factory.CreateClient();\n        await Assert.That(true).IsTrue();\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"can-i-run-async-code-in-configuretestservices",children:"Can I run async code in ConfigureTestServices?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," ASP.NET Core's configuration methods are synchronous, but you need async initialization."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Do async work in ",(0,r.jsx)(n.code,{children:"SetupAsync"}),", then use the results in sync methods:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class MyTest : TestsBase\n{\n    private string _authToken = null!;\n\n    protected override async Task SetupAsync()\n    {\n        // Async work here\n        _authToken = await GetAuthTokenAsync();\n    }\n\n    protected override void ConfigureTestServices(IServiceCollection services)\n    {\n        // Use the result from SetupAsync\n        services.AddSingleton(new AuthConfig { Token = _authToken });\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"why-does-my-programcs-run-before-configurewebhosts-configureappconfiguration",children:"Why does my Program.cs run before ConfigureWebHost's ConfigureAppConfiguration?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," You set configuration values in ",(0,r.jsx)(n.code,{children:"ConfigureWebHost"})," using ",(0,r.jsx)(n.code,{children:"ConfigureAppConfiguration"}),", but your app's ",(0,r.jsx)(n.code,{children:"Program.cs"})," doesn't see them during startup. Your breakpoint in Program.cs hits ",(0,r.jsx)(n.strong,{children:"before"})," the ",(0,r.jsx)(n.code,{children:"ConfigureAppConfiguration"})," callback."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Factory - this approach has a timing issue!\nprotected override void ConfigureWebHost(IWebHostBuilder builder)\n{\n    Console.WriteLine("ConfigureWebHost called");  // This runs first...\n\n    builder.ConfigureAppConfiguration((_, config) =>\n    {\n        Console.WriteLine("ConfigureAppConfiguration callback");  // ...but THIS runs AFTER Program.cs!\n        config.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "SomeKey", "SomeValue" }\n        });\n    });\n}\n\n// Program.cs - this runs BEFORE ConfigureAppConfiguration callback!\nvar builder = WebApplication.CreateBuilder(args);\nif (builder.Configuration["SomeKey"] != "SomeValue")\n{\n    throw new InvalidOperationException("SomeKey not found!");  // This throws!\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Root Cause:"})," This is ",(0,r.jsx)(n.strong,{children:"expected behavior"})," of ASP.NET Core's ",(0,r.jsx)(n.code,{children:"WebApplicationFactory"}),". The ",(0,r.jsx)(n.code,{children:"ConfigureAppConfiguration"})," callbacks registered in ",(0,r.jsx)(n.code,{children:"ConfigureWebHost"})," are ",(0,r.jsx)(n.strong,{children:"deferred"})," and run ",(0,r.jsx)(n.strong,{children:"after"})," your app's ",(0,r.jsx)(n.code,{children:"Program.cs"})," code, not before."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Use ",(0,r.jsx)(n.code,{children:"ConfigureStartupConfiguration"})," instead, which uses ",(0,r.jsx)(n.code,{children:"builder.UseSetting()"})," to apply configuration ",(0,r.jsx)(n.strong,{children:"before"})," your app's ",(0,r.jsx)(n.code,{children:"Program.cs"})," runs:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class WebApplicationFactory : TestWebApplicationFactory<Program>\n{\n    /// <summary>\n    /// Use ConfigureStartupConfiguration for configuration your Program.cs needs during startup.\n    /// This runs BEFORE Program.cs.\n    /// </summary>\n    protected override void ConfigureStartupConfiguration(IConfigurationBuilder configurationBuilder)\n    {\n        configurationBuilder.AddInMemoryCollection(new Dictionary<string, string?>\n        {\n            { "SomeKey", "SomeValue" },  // Available when Program.cs runs!\n            { "Database:ConnectionString", "..." }\n        });\n    }\n\n    /// <summary>\n    /// ConfigureWebHost can still be used for other customizations,\n    /// but NOT for configuration that Program.cs needs during startup.\n    /// </summary>\n    protected override void ConfigureWebHost(IWebHostBuilder builder)\n    {\n        // Safe to use ConfigureAppConfiguration for config that\'s only\n        // needed AFTER the app has started (e.g., in controllers, services)\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"When to use each method:"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Method"}),(0,r.jsx)(n.th,{children:"Runs When"}),(0,r.jsx)(n.th,{children:"Use For"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigureStartupConfiguration"})}),(0,r.jsx)(n.td,{children:"Before Program.cs"}),(0,r.jsx)(n.td,{children:"Configuration needed during app startup"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"ConfigureWebHost"})," + ",(0,r.jsx)(n.code,{children:"ConfigureAppConfiguration"})]}),(0,r.jsx)(n.td,{children:"After Program.cs"}),(0,r.jsx)(n.td,{children:"Configuration only needed after app starts"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsx)(n.h3,{id:"webapplicationtest-properties",children:"WebApplicationTest Properties"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Property"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"UniqueId"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"int"})}),(0,r.jsx)(n.td,{children:"Unique identifier for this test instance"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GlobalFactory"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"TFactory"})}),(0,r.jsx)(n.td,{children:"Shared factory (your custom type)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Factory"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"WebApplicationFactory<TEntryPoint>"})}),(0,r.jsx)(n.td,{children:"Per-test isolated factory"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Services"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"IServiceProvider"})}),(0,r.jsx)(n.td,{children:"DI container from per-test factory"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"HttpCapture"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"HttpExchangeCapture?"})}),(0,r.jsx)(n.td,{children:"Captured HTTP exchanges (if enabled)"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"webapplicationtest-methods",children:"WebApplicationTest Methods"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Method"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GetIsolatedName(string baseName)"})}),(0,r.jsxs)(n.td,{children:["Returns ",(0,r.jsx)(n.code,{children:'"Test_{UniqueId}_{baseName}"'})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'GetIsolatedPrefix(string separator = "_")'})}),(0,r.jsxs)(n.td,{children:["Returns ",(0,r.jsx)(n.code,{children:'"test{separator}{UniqueId}{separator}"'})]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"webapplicationtestoptions",children:"WebApplicationTestOptions"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Property"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EnableHttpExchangeCapture"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"bool"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Capture HTTP requests/responses"})]})})]}),"\n",(0,r.jsx)(n.h3,{id:"service-collection-extensions",children:"Service Collection Extensions"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Method"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ReplaceService<T>(instance)"})}),(0,r.jsx)(n.td,{children:"Replace service with instance"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ReplaceService<T>(factory)"})}),(0,r.jsx)(n.td,{children:"Replace service with factory"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ReplaceService<TService, TImpl>()"})}),(0,r.jsx)(n.td,{children:"Replace service with implementation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RemoveService<T>()"})}),(0,r.jsx)(n.td,{children:"Remove service registration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"AddTUnitLogging(context)"})}),(0,r.jsx)(n.td,{children:"Add TUnit logging provider"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(96540);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);