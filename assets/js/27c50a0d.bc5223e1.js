"use strict";(globalThis.webpackChunktunit_docs_site=globalThis.webpackChunktunit_docs_site||[]).push([[6463],{45278(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"test-authoring/mocking/http","title":"HTTP Mocking","description":"TUnit.Mocks.Http provides MockHttpHandler \u2014 a drop-in HttpMessageHandler replacement for testing code that uses HttpClient.","source":"@site/docs/test-authoring/mocking/http.md","sourceDirName":"test-authoring/mocking","slug":"/test-authoring/mocking/http","permalink":"/docs/test-authoring/mocking/http","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docs","previous":{"title":"Advanced Features","permalink":"/docs/test-authoring/mocking/advanced"},"next":{"title":"Logging","permalink":"/docs/test-authoring/mocking/logging"}}');var r=t(74848),i=t(28453);const d={sidebar_position:6},a="HTTP Mocking",c={},l=[{value:"Getting Started",id:"getting-started",level:2},{value:"Creating a Client",id:"creating-a-client",level:2},{value:"Setting Up Responses",id:"setting-up-responses",level:2},{value:"By HTTP Method",id:"by-http-method",level:3},{value:"Any Request",id:"any-request",level:3},{value:"Custom Matching",id:"custom-matching",level:3},{value:"Request Matcher Reference",id:"request-matcher-reference",level:3},{value:"Response Configuration",id:"response-configuration",level:2},{value:"Basic Responses",id:"basic-responses",level:3},{value:"Response Builder",id:"response-builder",level:3},{value:"Dynamic Responses",id:"dynamic-responses",level:3},{value:"Simulating Delays",id:"simulating-delays",level:3},{value:"Throwing Exceptions",id:"throwing-exceptions",level:3},{value:"Sequential Responses",id:"sequential-responses",level:2},{value:"Unmatched Requests",id:"unmatched-requests",level:2},{value:"Verification",id:"verification",level:2},{value:"Verify Call Count",id:"verify-call-count",level:3},{value:"Verify No Unmatched Requests",id:"verify-no-unmatched-requests",level:3},{value:"Inspect Captured Requests",id:"inspect-captured-requests",level:3},{value:"Reset",id:"reset",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"http-mocking",children:"HTTP Mocking"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"TUnit.Mocks.Http"})," provides ",(0,r.jsx)(n.code,{children:"MockHttpHandler"})," \u2014 a drop-in ",(0,r.jsx)(n.code,{children:"HttpMessageHandler"})," replacement for testing code that uses ",(0,r.jsx)(n.code,{children:"HttpClient"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet add package TUnit.Mocks.Http --prerelease\n"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using TUnit.Mocks;\n\n[Test]\npublic async Task Fetches_Users_From_Api()\n{\n    // Arrange \u2014 MockHttpClient is a real HttpClient with a .Handler property\n    using var client = Mock.HttpClient("https://example.com");\n    client.Handler.OnGet("/api/users").RespondWithJson("""[{"id": 1, "name": "Alice"}]""");\n\n    // Act\n    var response = await client.GetAsync("/api/users");\n    var body = await response.Content.ReadAsStringAsync();\n\n    // Assert\n    await Assert.That(response.StatusCode).IsEqualTo(HttpStatusCode.OK);\n    await Assert.That(body).Contains("Alice");\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-client",children:"Creating a Client"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Mock.HttpClient()"})," returns a ",(0,r.jsx)(n.code,{children:"MockHttpClient"})," \u2014 a subclass of ",(0,r.jsx)(n.code,{children:"HttpClient"})," with a ",(0,r.jsx)(n.code,{children:".Handler"})," property for configuring setups and verifying calls:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// With base address (most common)\nusing var client = Mock.HttpClient("https://api.example.com");\n\n// Without base address\nusing var client = Mock.HttpClient();\nclient.BaseAddress = new Uri("https://api.example.com");\n\n// Just the handler (when you need more control)\nvar handler = Mock.HttpHandler();\nusing var client = handler.CreateClient("https://api.example.com");\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"MockHttpClient"})," ",(0,r.jsx)(n.strong,{children:"is"})," an ",(0,r.jsx)(n.code,{children:"HttpClient"})," \u2014 pass it anywhere ",(0,r.jsx)(n.code,{children:"HttpClient"})," is expected. Use ",(0,r.jsx)(n.code,{children:".Handler"})," for all setup and verification:"]}),"\n",(0,r.jsx)(n.h2,{id:"setting-up-responses",children:"Setting Up Responses"}),"\n",(0,r.jsxs)(n.p,{children:["All setup is done through ",(0,r.jsx)(n.code,{children:"client.Handler"})," (or directly on a ",(0,r.jsx)(n.code,{children:"MockHttpHandler"})," if you created one with ",(0,r.jsx)(n.code,{children:"Mock.HttpHandler()"}),")."]}),"\n",(0,r.jsx)(n.h3,{id:"by-http-method",children:"By HTTP Method"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.OnGet("/api/users").RespondWithJson("""[{"id": 1}]""");\nclient.Handler.OnPost("/api/users").Respond(HttpStatusCode.Created);\nclient.Handler.OnPut("/api/users/1").Respond(HttpStatusCode.NoContent);\nclient.Handler.OnDelete("/api/users/1").Respond(HttpStatusCode.NoContent);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"any-request",children:"Any Request"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"client.Handler.OnAnyRequest().Respond(HttpStatusCode.OK);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"custom-matching",children:"Custom Matching"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"OnRequest"})," with a fluent matcher for complex conditions:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Match by path prefix\nclient.Handler.OnRequest(r => r.Method(HttpMethod.Get).PathStartsWith("/api/v2"))\n    .RespondWithJson("""{"version": 2}""");\n\n// Match by regex\nclient.Handler.OnRequest(r => r.PathMatches(@"/api/users/\\d+"))\n    .RespondWithJson("""{"id": 1, "name": "Alice"}""");\n\n// Match by header\nclient.Handler.OnRequest(r => r.HasHeader("Authorization"))\n    .RespondWithJson("""{"authenticated": true}""");\n\nclient.Handler.OnRequest(r => r.Header("Authorization", "Bearer valid-token"))\n    .RespondWithJson("""{"user": "admin"}""");\n\n// Match by body content\nclient.Handler.OnRequest(r => r.BodyContains("searchQuery"))\n    .RespondWithJson("""{"results": []}""");\n\n// Custom predicate\nclient.Handler.OnRequest(r => r.Matching(msg => msg.RequestUri?.Port == 8080))\n    .Respond(HttpStatusCode.OK);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"request-matcher-reference",children:"Request Matcher Reference"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Method"}),(0,r.jsx)(n.th,{children:"Matches"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".Method(HttpMethod)"})}),(0,r.jsx)(n.td,{children:"Specific HTTP method"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".Path(string)"})}),(0,r.jsx)(n.td,{children:"Exact path"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".PathStartsWith(string)"})}),(0,r.jsx)(n.td,{children:"Path prefix"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".PathMatches(string)"})}),(0,r.jsx)(n.td,{children:"Regex pattern on path"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".Header(name, value)"})}),(0,r.jsx)(n.td,{children:"Header with exact value"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".HasHeader(name)"})}),(0,r.jsx)(n.td,{children:"Header present (any value)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".BodyContains(string)"})}),(0,r.jsx)(n.td,{children:"Request body contains text"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".Matching(predicate)"})}),(0,r.jsxs)(n.td,{children:["Custom ",(0,r.jsx)(n.code,{children:"Func<HttpRequestMessage, bool>"})]})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"response-configuration",children:"Response Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"basic-responses",children:"Basic Responses"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'// Status code only\nclient.Handler.OnGet("/health").Respond(HttpStatusCode.OK);\n\n// JSON body\nclient.Handler.OnGet("/api/data").RespondWithJson("""{"key": "value"}""");\n\n// Plain text body\nclient.Handler.OnGet("/api/version").RespondWithString("1.0.0");\n'})}),"\n",(0,r.jsx)(n.h3,{id:"response-builder",children:"Response Builder"}),"\n",(0,r.jsx)(n.p,{children:"For more control, use the response builder:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.OnGet("/api/data")\n    .Respond(HttpStatusCode.OK)\n    .WithJsonContent("""{"key": "value"}""")\n    .WithHeader("X-Request-Id", "abc123");\n'})}),"\n",(0,r.jsx)(n.h3,{id:"dynamic-responses",children:"Dynamic Responses"}),"\n",(0,r.jsx)(n.p,{children:"Build responses based on the incoming request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.OnPost("/api/echo")\n    .Respond()\n    .WithFactory(request =>\n    {\n        var body = request.Content?.ReadAsStringAsync().Result ?? "";\n        return new HttpResponseMessage(HttpStatusCode.OK)\n        {\n            Content = new StringContent(body)\n        };\n    });\n'})}),"\n",(0,r.jsx)(n.h3,{id:"simulating-delays",children:"Simulating Delays"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.OnGet("/api/slow")\n    .Respond(HttpStatusCode.OK)\n    .WithDelay(TimeSpan.FromSeconds(2));\n'})}),"\n",(0,r.jsx)(n.h3,{id:"throwing-exceptions",children:"Throwing Exceptions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.OnGet("/api/failing")\n    .Throws("Connection refused");\n\nclient.Handler.OnGet("/api/timeout")\n    .Throws(new TaskCanceledException("Request timed out"));\n'})}),"\n",(0,r.jsx)(n.h2,{id:"sequential-responses",children:"Sequential Responses"}),"\n",(0,r.jsx)(n.p,{children:"Return different responses for successive requests to the same endpoint:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'var setup = client.Handler.OnGet("/api/status");\nsetup.RespondWithString("starting");\nsetup.Then().RespondWithString("running");\nsetup.Then().RespondWithString("complete");\n\n// 1st call: "starting"\n// 2nd call: "running"\n// 3rd+ calls: "complete" (last response repeats)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"unmatched-requests",children:"Unmatched Requests"}),"\n",(0,r.jsxs)(n.p,{children:["By default, unmatched requests return ",(0,r.jsx)(n.strong,{children:"404 Not Found"}),". You can change this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"// Change default status code\nclient.Handler.WithDefaultStatus(HttpStatusCode.ServiceUnavailable);\n\n// Or throw on unmatched requests\nclient.Handler.ThrowOnUnmatched();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,r.jsx)(n.h3,{id:"verify-call-count",children:"Verify Call Count"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'client.Handler.Verify(r => r.Method(HttpMethod.Get).Path("/api/users"), Times.Once);\nclient.Handler.Verify(r => r.Method(HttpMethod.Delete), Times.Never);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"verify-no-unmatched-requests",children:"Verify No Unmatched Requests"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"client.Handler.VerifyNoUnmatchedRequests();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"inspect-captured-requests",children:"Inspect Captured Requests"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'await Assert.That(client.Handler.Requests).HasCount().EqualTo(2);\nawait Assert.That(client.Handler.Requests[0].Method).IsEqualTo(HttpMethod.Get);\nawait Assert.That(client.Handler.Requests[0].RequestUri!.PathAndQuery).IsEqualTo("/api/users");\n\n// Check for unmatched requests\nawait Assert.That(client.Handler.UnmatchedRequests).HasCount().EqualTo(0);\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Each ",(0,r.jsx)(n.code,{children:"CapturedRequest"})," provides:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Property"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Method"})}),(0,r.jsx)(n.td,{children:"HTTP method"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RequestUri"})}),(0,r.jsx)(n.td,{children:"Full request URI"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Body"})}),(0,r.jsx)(n.td,{children:"Request body as string (or null)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Headers"})}),(0,r.jsx)(n.td,{children:"Request headers"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Matched"})}),(0,r.jsx)(n.td,{children:"Whether a setup matched this request"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Timestamp"})}),(0,r.jsx)(n.td,{children:"When the request was captured"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"reset",children:"Reset"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"client.Handler.Reset(); // clears all setups and captured requests\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453(e,n,t){t.d(n,{R:()=>d,x:()=>a});var s=t(96540);const r={},i=s.createContext(r);function d(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);