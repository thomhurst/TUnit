<?xml version="1.0" encoding="utf-8"?>
<Project>

    <ItemGroup Condition="'$(TUnitImplicitUsings)' == 'true'">
        <Using Include="TUnit.Core.HookType" Static="True" />
        <Using Include="TUnit.Core" />
    </ItemGroup>

    <!-- Auto-include Polyfill package for compile-time type generation -->
    <PropertyGroup>
        <_TUnitPolyfillVersion>8.7.4</_TUnitPolyfillVersion>
        <_TUnitNeedsPolyfill Condition="'$(TargetFramework)' == 'netstandard2.0' or '$(TargetFramework)' == 'netstandard2.1' or '$(TargetFrameworkIdentifier)' == '.NETFramework'">true</_TUnitNeedsPolyfill>
    </PropertyGroup>

    <!-- Add Polyfill for non-CPM projects -->
    <ItemGroup Condition="'$(EnableTUnitPolyfills)' != 'false' and '$(_TUnitNeedsPolyfill)' == 'true' and '$(ManagePackageVersionsCentrally)' != 'true'">
        <PackageReference Include="Polyfill" Version="$(_TUnitPolyfillVersion)">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>compile; analyzers</IncludeAssets>
            <ExcludeAssets>runtime; native; contentfiles; build; buildtransitive</ExcludeAssets>
        </PackageReference>
    </ItemGroup>

    <!-- Add Polyfill for CPM projects (without version) -->
    <ItemGroup Condition="'$(EnableTUnitPolyfills)' != 'false' and '$(_TUnitNeedsPolyfill)' == 'true' and '$(ManagePackageVersionsCentrally)' == 'true'">
        <PackageReference Include="Polyfill">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>compile; analyzers</IncludeAssets>
            <ExcludeAssets>runtime; native; contentfiles; build; buildtransitive</ExcludeAssets>
        </PackageReference>
    </ItemGroup>

    <!-- Validate and provide helpful messages for CPM users -->
    <Target Name="_TUnitEnsurePolyfill" 
            BeforeTargets="GenerateBuildDependencyFile"
            Condition="'$(EnableTUnitPolyfills)' != 'false' and '$(_TUnitNeedsPolyfill)' == 'true'">
        <Warning Condition="'$(ManagePackageVersionsCentrally)' == 'true' and !Exists('$(NuGetPackageRoot)polyfill')"
                 Code="TUNIT001"
                 Text="TUnit requires Polyfill package for $(TargetFramework). Add to Directory.Packages.props: &lt;PackageVersion Include='Polyfill' Version='$(_TUnitPolyfillVersion)' /&gt;" />
    </Target>

</Project>
