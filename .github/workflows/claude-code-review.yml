name: Claude Code Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  external-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            <task>
            Review PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.
            </task>

            <instructions>
            FIRST: Read CLAUDE.md to understand TUnit's critical rules and coding standards.

            THEN: Use `gh pr diff ${{ github.event.pull_request.number }}` to see the changes. Think carefully about each change before commenting.

            INVESTIGATE before commenting. Read any files you need to understand context. Never speculate about code you haven't inspected.
            </instructions>

            <tunit_critical_rules>
            These are blocking issues if violated:
            1. DUAL-MODE: Changes to TUnit.Core.SourceGenerator or TUnit.Engine test discovery must work in both modes
            2. SNAPSHOTS: Source generator or public API changes require .verified.txt updates (never .received.txt)
            3. NO VSTEST: Microsoft.VisualStudio.TestPlatform is forbidden - only Microsoft.Testing.Platform
            4. AOT: Reflection usage must have [DynamicallyAccessedMembers] annotations
            5. PERFORMANCE: No unnecessary allocations in hot paths (discovery, execution, data generation)
            </tunit_critical_rules>

            <review_focus>
            Only flag issues that matter:
            - Critical: Bugs, security vulnerabilities, TUnit rule violations
            - Important: Performance problems, missing tests for new functionality
            - Suggestions: Better approaches (only if significantly better)

            DO NOT comment on:
            - Style preferences handled by linters/formatters
            - Minor naming suggestions
            - Obvious or self-explanatory code
            - Things that are clearly intentional design choices
            </review_focus>

            <output_format>
            Structure your review as:

            ## Summary
            One sentence: what does this PR do?

            ## Critical Issues
            List any blocking problems. If none, state "None found."

            ## Suggestions
            Optional improvements worth considering. Keep brief.

            ## Verdict
            ‚úÖ APPROVE - Ready to merge (no critical issues)
            ‚ö†Ô∏è REQUEST CHANGES - Critical issues must be addressed
            üí¨ COMMENT - Questions or non-blocking feedback only

            If previous review comments exist, note which issues were addressed.
            </output_format>

            Post your review using `gh pr comment ${{ github.event.pull_request.number }}`.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
