using TUnit.Mocks.SourceGenerator.Models;

namespace TUnit.Mocks.SourceGenerator.Builders;

internal static class MockDelegateFactoryBuilder
{
    public static string Build(MockTypeModel model)
    {
        var writer = new CodeWriter();
        var safeName = MockImplBuilder.GetCompositeSafeName(model);

        // The delegate has exactly one method: Invoke
        var invokeMethod = model.Methods[0];

        writer.AppendLine("// <auto-generated/>");
        writer.AppendLine("#nullable enable");
        writer.AppendLine();

        using (writer.Block("namespace TUnit.Mocks.Generated"))
        {
            using (writer.Block($"internal static class {safeName}_MockDelegateFactory"))
            {
                writer.AppendLine("[global::System.Runtime.CompilerServices.ModuleInitializer]");
                using (writer.Block("internal static void Register()"))
                {
                    writer.AppendLine($"global::TUnit.Mocks.Mock.RegisterDelegateFactory<{model.FullyQualifiedName}>(Create);");
                }
                writer.AppendLine();

                using (writer.Block($"private static global::TUnit.Mocks.Mock<{model.FullyQualifiedName}> Create(global::TUnit.Mocks.MockBehavior behavior)"))
                {
                    writer.AppendLine($"var engine = new global::TUnit.Mocks.MockEngine<{model.FullyQualifiedName}>(behavior);");

                    // Build the delegate lambda that dispatches through the engine
                    var paramList = BuildLambdaParameterList(invokeMethod);
                    var argsArray = BuildArgsArray(invokeMethod);

                    var hasOutParams = invokeMethod.Parameters.Any(p => p.Direction == ParameterDirection.Out);

                    if (invokeMethod.IsVoid)
                    {
                        // void delegate (Action<...>)
                        writer.AppendLine($"{model.FullyQualifiedName} del = ({paramList}) =>");
                        writer.AppendLine("{");
                        writer.IncreaseIndent();
                        if (hasOutParams)
                        {
                            foreach (var p in invokeMethod.Parameters.Where(p => p.Direction == ParameterDirection.Out))
                            {
                                writer.AppendLine($"{p.Name} = default!;");
                            }
                        }
                        writer.AppendLine($"engine.HandleCall({invokeMethod.MemberId}, \"Invoke\", {argsArray});");
                        writer.DecreaseIndent();
                        writer.AppendLine("};");
                    }
                    else
                    {
                        // returning delegate (Func<..., TReturn>)
                        writer.AppendLine($"{model.FullyQualifiedName} del = ({paramList}) =>");
                        writer.AppendLine("{");
                        writer.IncreaseIndent();
                        if (hasOutParams)
                        {
                            foreach (var p in invokeMethod.Parameters.Where(p => p.Direction == ParameterDirection.Out))
                            {
                                writer.AppendLine($"{p.Name} = default!;");
                            }
                        }
                        writer.AppendLine($"return engine.HandleCallWithReturn<{invokeMethod.ReturnType}>({invokeMethod.MemberId}, \"Invoke\", {argsArray}, {invokeMethod.SmartDefault});");
                        writer.DecreaseIndent();
                        writer.AppendLine("};");
                    }

                    writer.AppendLine($"var setup = new {safeName}_MockSetup(engine);");
                    writer.AppendLine($"var verify = new {safeName}_MockVerify(engine);");
                    writer.AppendLine($"var mock = new global::TUnit.Mocks.Mock<{model.FullyQualifiedName}>(del, setup, verify, engine);");
                    writer.AppendLine("return mock;");
                }
            }
        }

        return writer.ToString();
    }

    private static string BuildLambdaParameterList(MockMemberModel method)
    {
        if (method.Parameters.Length == 0) return "";
        return string.Join(", ", method.Parameters.Select(p =>
        {
            var direction = p.Direction switch
            {
                ParameterDirection.Out => "out ",
                ParameterDirection.Ref => "ref ",
                ParameterDirection.In_Readonly => "in ",
                _ => ""
            };
            return $"{direction}{p.FullyQualifiedType} {p.Name}";
        }));
    }

    private static string BuildArgsArray(MockMemberModel method)
    {
        if (method.Parameters.Length == 0)
            return "global::System.Array.Empty<object?>()";
        var args = string.Join(", ", method.Parameters.Select(p => p.Name));
        return $"new object?[] {{ {args} }}";
    }
}
