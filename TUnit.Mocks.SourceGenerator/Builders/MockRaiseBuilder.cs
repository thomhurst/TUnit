using TUnit.Mocks.SourceGenerator.Models;

namespace TUnit.Mocks.SourceGenerator.Builders;

internal static class MockRaiseBuilder
{
    public static string Build(MockTypeModel model)
    {
        var writer = new CodeWriter();
        var safeName = MockImplBuilder.GetSafeName(model.FullyQualifiedName);

        writer.AppendLine("// <auto-generated/>");
        writer.AppendLine("#nullable enable");
        writer.AppendLine();

        using (writer.Block("namespace TUnit.Mocks.Generated"))
        {
            // Data holder class implementing marker interface
            using (writer.Block($"public sealed class {safeName}_MockRaise : global::TUnit.Mocks.IMockRaise<{model.FullyQualifiedName}>"))
            {
                writer.AppendLine($"internal readonly {safeName}_MockImpl Impl;");
                writer.AppendLine();
                writer.AppendLine($"internal {safeName}_MockRaise({safeName}_MockImpl impl) => Impl = impl;");
            }

            writer.AppendLine();

            // Extension methods class
            using (writer.Block($"public static class {safeName}_MockRaiseExtensions"))
            {
                bool firstMember = true;
                foreach (var evt in model.Events)
                {
                    if (!firstMember) writer.AppendLine();
                    firstMember = false;
                    GenerateRaiseMethod(writer, evt, model, safeName);
                }
            }
        }

        return writer.ToString();
    }

    private static void GenerateRaiseMethod(CodeWriter writer, MockEventModel evt, MockTypeModel model, string safeName)
    {
        var extensionParam = $"this global::TUnit.Mocks.IMockRaise<{model.FullyQualifiedName}> raise";

        // Build parameter list: extension param + raise parameters
        var raiseParamStr = evt.RaiseParameterList.Length == 0
            ? ""
            : string.Join(", ", evt.RaiseParameterList.Select(p => $"{p.FullyQualifiedType} {p.Name}"));
        var raiseParams = string.IsNullOrEmpty(raiseParamStr)
            ? extensionParam
            : $"{extensionParam}, {raiseParamStr}";

        // Build argument pass-through for the Raise_ call using structured parameter data
        var raiseArgNames = evt.RaiseParameterList.Length == 0
            ? ""
            : string.Join(", ", evt.RaiseParameterList.Select(p => p.Name));

        using (writer.Block($"public static void {evt.Name}({raiseParams})"))
        {
            writer.AppendLine($"var r = ({safeName}_MockRaise)raise;");
            writer.AppendLine($"r.Impl.Raise_{evt.Name}({raiseArgNames});");
        }
    }
}
