using TUnit.Mocks.SourceGenerator.Models;

namespace TUnit.Mocks.SourceGenerator.Builders;

internal static class MockEventsBuilder
{
    public static string Build(MockTypeModel model)
    {
        var writer = new CodeWriter();
        var safeName = MockImplBuilder.GetSafeName(model.FullyQualifiedName);

        writer.AppendLine("// <auto-generated/>");
        writer.AppendLine("#nullable enable");
        writer.AppendLine();

        using (writer.Block("namespace TUnit.Mocks.Generated"))
        {
            // Lightweight struct holding engine reference — no allocation
            writer.AppendLine("[global::System.ComponentModel.EditorBrowsable(global::System.ComponentModel.EditorBrowsableState.Never)]");
            using (writer.Block($"public readonly struct {safeName}_MockEvents"))
            {
                writer.AppendLine($"internal readonly global::TUnit.Mocks.MockEngine<{model.FullyQualifiedName}> Engine;");
                writer.AppendLine();
                writer.AppendLine($"internal {safeName}_MockEvents(global::TUnit.Mocks.MockEngine<{model.FullyQualifiedName}> engine) => Engine = engine;");
            }

            writer.AppendLine();

            using (writer.Block($"public static class {safeName}_MockEventsExtensions"))
            {
                // Extension property on Mock<T> — non-nullable, only present when type has events
                using (writer.Block($"extension(global::TUnit.Mocks.Mock<{model.FullyQualifiedName}> mock)"))
                {
                    writer.AppendLine($"public {safeName}_MockEvents Events => new(mock.Engine);");
                }

                writer.AppendLine();

                // Per-event extension properties on the events struct
                using (writer.Block($"extension({safeName}_MockEvents events)"))
                {
                    bool first = true;
                    foreach (var evt in model.Events)
                    {
                        if (!first) writer.AppendLine();
                        first = false;

                        writer.AppendLine($"public global::TUnit.Mocks.EventSubscriptionAccessor {evt.Name}");
                        writer.AppendLine($"    => new(events.Engine, \"{evt.Name}\");");
                    }
                }
            }
        }

        return writer.ToString();
    }
}
