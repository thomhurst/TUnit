using System.Runtime.CompilerServices;
using TUnit.Core;
using TUnit.Core.Interfaces;

namespace TUnit.FsCheck;

/// <summary>
/// Marks a test method as an FsCheck property-based test.
/// The test method parameters will be generated by FsCheck and the test
/// will be run multiple times with different generated values.
/// </summary>
public class FsCheckPropertyAttribute : BaseTestAttribute, ITestRegisteredEventReceiver
{
    public FsCheckPropertyAttribute([CallerFilePath] string file = "", [CallerLineNumber] int line = 0)
        : base(file, line)
    {
    }

    /// <summary>
    /// The maximum number of tests to run. Default is 100.
    /// </summary>
    public int MaxTest { get; set; } = 100;

    /// <summary>
    /// The maximum number of rejected tests (tests that failed the precondition) before failing.
    /// </summary>
    public int MaxFail { get; set; } = 1000;

    /// <summary>
    /// The starting size for test generation. Size increases linearly between StartSize and EndSize.
    /// </summary>
    public int StartSize { get; set; } = 1;

    /// <summary>
    /// The ending size for test generation. Size increases linearly between StartSize and EndSize.
    /// </summary>
    public int EndSize { get; set; } = 100;

    /// <summary>
    /// If set, replay the test using this seed. Format: "seed1,seed2" or just "seed1".
    /// Useful for reproducing failures.
    /// </summary>
    public string? Replay { get; set; }

    /// <summary>
    /// If true, output all generated arguments to the test output.
    /// </summary>
    public bool Verbose { get; set; }

    /// <summary>
    /// If true, suppress output on passing tests.
    /// </summary>
    public bool QuietOnSuccess { get; set; }

    /// <summary>
    /// The level of parallelism to use when running tests.
    /// Default is 1 (no parallelism within property execution).
    /// </summary>
    public int Parallelism { get; set; } = 1;

    /// <summary>
    /// Types containing Arbitrary instances to use for generating test data.
    /// </summary>
    public Type[]? Arbitrary { get; set; }

    /// <summary>
    /// Gets the order in which this event receiver is executed.
    /// </summary>
    public int Order => 0;

    /// <summary>
    /// Called when the test is registered. Sets up the FsCheck property executor.
    /// </summary>
    public ValueTask OnTestRegistered(TestRegisteredContext context)
    {
        context.SetTestExecutor(new FsCheckPropertyTestExecutor(this));
        return default;
    }
}
