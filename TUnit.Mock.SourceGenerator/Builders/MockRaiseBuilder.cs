using TUnit.Mock.SourceGenerator.Models;

namespace TUnit.Mock.SourceGenerator.Builders;

internal static class MockRaiseBuilder
{
    public static string Build(MockTypeModel model)
    {
        var writer = new CodeWriter();
        var safeName = MockImplBuilder.GetSafeName(model.Name);

        writer.AppendLine("// <auto-generated/>");
        writer.AppendLine("#nullable enable");
        writer.AppendLine();

        using (writer.Block("namespace TUnit.Mock.Generated"))
        {
            using (writer.Block($"public sealed class {safeName}_MockRaise"))
            {
                writer.AppendLine($"private readonly {safeName}_MockImpl _impl;");
                writer.AppendLine();
                writer.AppendLine($"internal {safeName}_MockRaise({safeName}_MockImpl impl) => _impl = impl;");

                foreach (var evt in model.Events)
                {
                    writer.AppendLine();
                    GenerateRaiseMethod(writer, evt);
                }
            }
        }

        return writer.ToString();
    }

    private static void GenerateRaiseMethod(CodeWriter writer, MockEventModel evt)
    {
        using (writer.Block($"public void {evt.Name}({evt.EventArgsType} args)"))
        {
            writer.AppendLine($"_impl.Raise_{evt.Name}(args);");
        }
    }
}
