using TUnit.Mock.SourceGenerator.Models;

namespace TUnit.Mock.SourceGenerator.Builders;

internal static class MockSetupBuilder
{
    public static string Build(MockTypeModel model)
    {
        var writer = new CodeWriter();
        var safeName = MockImplBuilder.GetSafeName(model.FullyQualifiedName);

        writer.AppendLine("// <auto-generated/>");
        writer.AppendLine("#nullable enable");
        writer.AppendLine();

        using (writer.Block("namespace TUnit.Mock.Generated"))
        {
            using (writer.Block($"public sealed class {safeName}_MockSetup"))
            {
                writer.AppendLine($"private readonly global::TUnit.Mock.MockEngine<{model.FullyQualifiedName}> _engine;");
                writer.AppendLine();
                writer.AppendLine($"internal {safeName}_MockSetup(global::TUnit.Mock.MockEngine<{model.FullyQualifiedName}> engine) => _engine = engine;");

                // Methods
                foreach (var method in model.Methods)
                {
                    writer.AppendLine();
                    GenerateSetupMethod(writer, method);
                }

                // Properties
                foreach (var prop in model.Properties)
                {
                    if (prop.IsIndexer) continue;
                    if (!prop.HasGetter && !prop.HasSetter) continue;
                    writer.AppendLine();
                    GenerateSetupProperty(writer, prop);
                }
            }
        }

        return writer.ToString();
    }

    private static void GenerateSetupMethod(CodeWriter writer, MockMemberModel method)
    {
        // For async methods (Task<T>/ValueTask<T>), unwrap the return type so users write .Returns(5) not .Returns(Task.FromResult(5))
        // For void-async methods (Task/ValueTask), IsVoid is already true
        var setupReturnType = method.IsAsync && !method.IsVoid
            ? method.UnwrappedReturnType
            : method.ReturnType;

        var returnType = method.IsVoid
            ? "global::TUnit.Mock.Setup.IVoidMethodSetup"
            : $"global::TUnit.Mock.Setup.IMethodSetup<{setupReturnType}>";

        var paramList = GetArgParameterList(method);
        var typeParams = GetTypeParameterList(method);
        var constraints = GetConstraintClauses(method);

        using (writer.Block($"public {returnType} {method.Name}{typeParams}({paramList}){constraints}"))
        {
            // Build matchers array
            var nonOutParams = method.Parameters.Where(p => p.Direction != ParameterDirection.Out).ToList();

            if (nonOutParams.Count == 0)
            {
                writer.AppendLine("var matchers = global::System.Array.Empty<global::TUnit.Mock.Arguments.IArgumentMatcher>();");
            }
            else
            {
                var matcherArgs = string.Join(", ", nonOutParams.Select(p => $"{p.Name}.Matcher"));
                writer.AppendLine($"var matchers = new global::TUnit.Mock.Arguments.IArgumentMatcher[] {{ {matcherArgs} }};");
            }

            writer.AppendLine($"var setup = new global::TUnit.Mock.Setup.MethodSetup({method.MemberId}, matchers);");
            writer.AppendLine("_engine.AddSetup(setup);");

            if (method.IsVoid)
            {
                writer.AppendLine("return new global::TUnit.Mock.Setup.VoidMethodSetupBuilder(setup);");
            }
            else
            {
                writer.AppendLine($"return new global::TUnit.Mock.Setup.MethodSetupBuilder<{setupReturnType}>(setup);");
            }
        }
    }

    private static void GenerateSetupProperty(CodeWriter writer, MockMemberModel prop)
    {
        // Property getter setup returns IPropertySetup<T>
        if (prop.HasGetter)
        {
            using (writer.Block($"public global::TUnit.Mock.Setup.IPropertySetup<{prop.ReturnType}> {prop.Name}_Get()"))
            {
                writer.AppendLine("var matchers = global::System.Array.Empty<global::TUnit.Mock.Arguments.IArgumentMatcher>();");
                writer.AppendLine($"var setup = new global::TUnit.Mock.Setup.MethodSetup({prop.MemberId}, matchers);");
                writer.AppendLine("_engine.AddSetup(setup);");
                writer.AppendLine($"return new global::TUnit.Mock.Setup.PropertySetupBuilder<{prop.ReturnType}>(setup);");
            }
        }

        // Property setter setup returns IPropertySetterSetup
        if (prop.HasSetter)
        {
            var setterMemberId = prop.MemberId + 10000;
            using (writer.Block($"public global::TUnit.Mock.Setup.IPropertySetterSetup {prop.Name}_Set(global::TUnit.Mock.Arguments.Arg<{prop.ReturnType}> value)"))
            {
                writer.AppendLine("var matchers = new global::TUnit.Mock.Arguments.IArgumentMatcher[] { value.Matcher };");
                writer.AppendLine($"var setup = new global::TUnit.Mock.Setup.MethodSetup({setterMemberId}, matchers);");
                writer.AppendLine("_engine.AddSetup(setup);");
                writer.AppendLine("return new global::TUnit.Mock.Setup.PropertySetterSetupBuilder(setup);");
            }
        }
    }

    private static string GetArgParameterList(MockMemberModel method)
    {
        // Only include non-out parameters as Arg<T> in setup
        return string.Join(", ", method.Parameters
            .Where(p => p.Direction != ParameterDirection.Out)
            .Select(p => $"global::TUnit.Mock.Arguments.Arg<{p.FullyQualifiedType}> {p.Name}"));
    }

    private static string GetTypeParameterList(MockMemberModel method)
    {
        if (method.TypeParameters.Length == 0) return "";
        return "<" + string.Join(", ", method.TypeParameters.Select(tp => tp.Name)) + ">";
    }

    private static string GetConstraintClauses(MockMemberModel method)
    {
        var clauses = new List<string>();
        foreach (var tp in method.TypeParameters)
        {
            if (!string.IsNullOrEmpty(tp.Constraints))
            {
                clauses.Add($"where {tp.Name} : {tp.Constraints}");
            }
        }
        return clauses.Count > 0 ? " " + string.Join(" ", clauses) : "";
    }
}
